stages:
  # [BUILDS]
  - stage: Builds
    jobs:
      # Web
      - job: WEB
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
        - script: yarn install
          displayName: 'Yarn install'
          workingDirectory: './web/website/'
        - script: yarn build
          displayName: 'Yarn build'
          workingDirectory: './web/website/'
      # API
      - job: API
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
        - script: docker-compose build
          displayName: 'Docker build'
          workingDirectory: './api/'

  # [TESTS]
  - stage: Tests
    jobs:
      # Web
      - job: WEB
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
        - script: yarn install
          displayName: 'Yarn install'
          workingDirectory: './web/website/'
        - script: yarn test
          displayName: 'Run jest test'
          workingDirectory: './web/website/'
      # API
      - job: API
        pool:
          vmImage: 'ubuntu-16.04'
        steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.6'
        - script: |
            pip install pytest
            pip install pytest-cov
            pytest ./api/api/tests.py --doctest-modules --junitxml=./testsOutput/api.xml --cov=com --cov-report=xml --cov-report=html
          displayName: 'Test with pytest'
          workingDirectory: './web/website/'        

  # [PUBLISH TESTS]
  - stage: Publish_Tests
    jobs:
      # Web
      - job: WEB
        steps:
        - task: PublishTestResults@2
          condition: succeededOrFailed()
          inputs:
            testRunner: JUnit
            testResultsFiles: './testsOutput/web.xml'
      # API
      - job: API
        steps:
        - task: PublishTestResults@2
          condition: succeededOrFailed()
          inputs:
            testResultsFiles: './testsOutput/api.xml'
            testRunTitle: 'Publish test results for Python $(python.version)'